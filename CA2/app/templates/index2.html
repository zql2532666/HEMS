{% extends "base.html" %}

{% block mainContent %}
        <style>
          .quick .toggle-group { transition: left 0.1s;      -webkit-transition: left 0.1s; }
        </style>

        <!-- Info boxes -->
        <div class="row">
          <div class="col-12 col-sm-6 col-md-3">
            <div class="info-box">
              <span class="info-box-icon bg-info elevation-1"><i class="fas fa-lightbulb"></i></span>

              <div class="info-box-content">
                <span class="info-box-text">Light Value</span>
                <span id="light_value" class="info-box-number">
                  0
                </span>
              </div>
              <!-- /.info-box-content -->
            </div>
            <!-- /.info-box -->
          </div>
          <!-- /.col -->
          <div class="col-12 col-sm-6 col-md-3">
            <div class="info-box mb-3">
              <span class="info-box-icon bg-danger elevation-1"><i class="fas fa-thermometer"></i></span>

              <div class="info-box-content">
                <span class="info-box-text">Temperature</span>
                <span id="temp-info" class="info-box-number"><span id="temperature">0</span><span>Â°C</span></span>
              </div>
              <!-- /.info-box-content -->
            </div>
            <!-- /.info-box -->
          </div>
          <!-- /.col -->

          <!-- fix for small devices only -->
          <div class="clearfix hidden-md-up"></div>

          <div class="col-12 col-sm-6 col-md-3">
            <div class="info-box mb-3">
              <span class="info-box-icon bg-success elevation-1"><i class="fas fa-tint"></i></span>

              <div class="info-box-content">
                <span class="info-box-text">Humidity</span>
                <span id="humid-info" class="info-box-number"><span id="humidity">0</span><span>%</span></span>
              </div>
              <!-- /.info-box-content -->
            </div>
            <!-- /.info-box -->
          </div>
          <!-- /.col -->
          <div class="col-12 col-sm-6 col-md-3">
            <div class="info-box mb-3">
              <span class="info-box-icon bg-warning elevation-1"><i class="fas fa-adjust"></i></span>
              <div class="info-box-content">
                <span class="info-box-text">LED Toggle</span>
                <input id="toggle-event" type="checkbox" checked data-toggle="toggle" data-onstyle="success" data-offstyle="danger" data-size="xs" data-style="quick" >
              </div>
              <!-- /.info-box-content -->
            </div>
            <!-- /.info-box -->
          </div>
          <!-- /.col -->
        </div>
        <!-- /.row -->

        <div class="row">
          <!-- Left col -->
          <section class="col-lg-12 connectedSortable">
            <!-- Custom tabs (Charts with tabs)-->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">
                  <i class="fas fa-chart-pie mr-1"></i>
                  Light Graph
                </h3>
                <button id="renderBtn" class="float-right btn btn-info">
                  Update
                </button>
              </div><!-- /.card-header -->
              <div class="card-body">
                <!-- Morris chart - Sales -->
                <div class="chart" style="position: relative; height: 300px;">
                  <canvas id="light-chart" height="300" style="height: 300px;"></canvas>                         
                </div>
              </div><!-- /.card-body -->
            </div>
            <!-- /.card -->

            <!-- TO DO List -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">
                  <i class="fas fa-database"></i>
                  Lights Database
                </h3>
                <button id="updateBtn" class="float-right btn btn-info">
                  Update
                </button>
              </div>
              <!-- /.card-header -->
              <div class="card-body">
                <table id="example2" class="table table-bordered table-hover">
                  <thead>
                    <tr>
                      <th>Datetime</th>
                      <th>Light Intensity</th>
                    </tr>
                  </thead>
                </table>
              </div>
              <!-- /.card-body -->
            </div>
            <!-- /.card -->
          </section>
          <!-- /.Left col -->
        </div>
        <!-- /.row (main row) -->
{% endblock %}
{% block script%}
  <!-- PAGE PLUGINS -->
  <!-- DataTables -->
  <script src="../../plugins/datatables/jquery.dataTables.min.js"></script>
  <script src="../../plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
  <script src="../../plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
  <script src="../../plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
  <!-- jQuery Mapael -->
  <script src="plugins/jquery-mousewheel/jquery.mousewheel.js"></script>
  <script src="plugins/raphael/raphael.min.js"></script>
  <script src="plugins/jquery-mapael/jquery.mapael.min.js"></script>
  <script src="plugins/jquery-mapael/maps/usa_states.min.js"></script>
  <!-- ChartJS -->
  <script src="plugins/chart.js/Chart.min.js"></script>

  <!-- PAGE SCRIPTS -->
  <script src="dist/js/pages/dashboard2.js"></script>

  <script>
    $(function () {
      getLEDStatus();
      setInterval(function(){
        getRealTimeData();
        getLEDStatus();
      }, 2000);
    });

    function getLEDStatus(){
      $.ajax({
        url: '/api/v1/led/status',
        type: 'GET',
        success: function(result) {
          if(result == 'on'){
            $('#toggle-event').bootstrapToggle('on', true);
          }else if(result == 'off'){
            $('#toggle-event').bootstrapToggle('off', true);
          }
        }
      });
    }

    function getRealTimeData(){
      $.ajax({
        url: '/api/v1/realtimedata',
        type: 'GET',
        success: function(result) {
          if (result.light == "-1") {
            $('#light_value').html("Disconnected");
          }else{
            $('#light_value').html(result.light);
          }

          if (result.humidity == "-1") {
            $('#temp-info').html("Disconnected");
            $('#humid-info').html("Disconnected");
          }else{
            $('#humidity').html(result.humidity);
            $('#temperature').html(result.temperature);
          }
        }
      });
    }

    var chartOptions = {
      maintainAspectRatio : false,
      responsive : true,
      datasetFill : false,
      legend: {
        display: false
      },
      scales: {
        xAxes: [{
          gridLines : {
            display : false,
          }
        }],
        yAxes: [{
          gridLines : {
            display : false,
          },
          ticks: {
            beginAtZero: true,
            steps: 10,
            stepValue: 5,
            max: 800
          }
        }]
      }
    }

    function renderChart(data, labels) {
        var ctx = document.getElementById("light-chart").getContext('2d');
        var myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'This week',
                    data: data,
                    fill: false
                }]
            },
            options: chartOptions
        });
    }
    var datetime;
    $("#renderBtn").click(
        function () {
            var data = []
            var labels = []

            $.ajax({
              url: '/api/v1/lightValueForChart',
              type: 'GET',
              success: function(result) {
                result = JSON.parse(result.replace(/'/g, '"'));
                data = result.data;
                labels = result.labels;

                // convert to more readable time
                for(var i = 0; i < labels.length; i++) {
                  jsdatetime = new Date(Date.parse(labels[i]));
                  labels[i] = jsdatetime.toLocaleTimeString();
                }

                renderChart(data, labels);
              }
            });
        }
    );

    var CustomRenders = {
      dateTime: function (data, type, row, meta) {
        jsdatetime = new Date(Date.parse(data));
        return jsdatetime.toLocaleString();
      }
    };
  
    var table;

    $(function () {
      table = $('#example2').DataTable({
        "ordering": true,
        "responsive": true,
        "autoWidth": false,
        "ajax": "/api/v1/lightValueForDatatable",
        "columns": [
          { "data": "datetime_value", "render": CustomRenders.dateTime},
          { "data": "light_value"}
        ],
        "columnDefs": [
            {
                "targets": [ 0 ],
                "visible": false,
                "searchable": false
            }
        ],
        "order": [[ 0, "desc" ]]
      });
    });
  
    $("#updateBtn").click(
        function () {
          //updateDatatable();
          table.ajax.reload( null, false );
        }
    );

    $(function() {
      $('#toggle-event').change(function() {
        $.ajax({
          url: '/api/v1/led/toggle',
          type: 'GET',
          success: function(result) {
            console.log("done")
          }
        });
      })
    })

    $("#renderBtn").click();
    getRealTimeData();
  </script>
{% endblock %}